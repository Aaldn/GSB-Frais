{% extends 'comptable/index.html.twig' %}

{% block title %}Administration fiche frais
{% endblock %}

{% block flashMessages %}
	{% for messages in app.flashes(['ligneFraisForfaitsValidee', 'ligneFraisHorsForfaitValide', 'ligneFraisHorsForfaitRefuse', 'ficheFraisValide', 'ficheFraisRembourse'])%}
		{% for message in messages %}
			<div class="alert alert-dismissible alert-success">
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				{{message}}
			</div>
		{% endfor %}
	{% endfor %}
	{% for message in app.flashes('ligneFraisHorsForfaitEnAttente')%}
		<div class="alert alert-dismissible alert-danger">
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			{{message}}
		</div>
	{% endfor %}
{% endblock %}

{% block contenuPage %}
	<h1>Administration fiche de frais</h1>
	<hr>
	<h3>Période d'engagement</h3>
	<h4>{{ficheFrais.mois | format_datetime(locale='fr',pattern="MMMM yyyy") | capitalize}}</h4>
	<h4>{{ficheFrais.idVisiteur.nom ~ ' ' ~ ficheFrais.idVisiteur.prenom}}</h4>
	<hr/>

	<h3>Frais au forfait</h3>
	<div class="table-responsive">
		<table class="table table-bordered table-active table-hover table-striped table-responsive">
			<thead class="thead-dark"></thead>
			<tr class="table-secondary">
				<th>Frais forfaitisés</th>
				<th>Forfait Etape</th>
				<th>Frais Kilométrique</th>
				<th>Nuitée Hôtel</th>
				<th>Repas Restaurant</th>
			</tr>
			<tbody>
				<tr>
					<td>Montants Unitaires</td>
					{% for fraisForfait in fraisForfaits %}
						<td>{{fraisForfait.montant|format_currency('EUR')}}</td>
					{% endfor %}
				</tr>
				<tr>
					<td>Quantité</td>
					{% for ligneFraisForfait in ligneFraisForfaits %}
						<td>{{ligneFraisForfait.quantite }}</td>
					{% endfor %}
				</tr>
				<tr>
					<td>Montants totaux</td>
					{% for ligneFraisForfait in ligneFraisForfaits %}
						<td>{{(ligneFraisForfait.quantite * fraisForfaits[loop.index0].montant)|format_currency('EUR')}}</td>
					{% endfor %}
				</tr>
				<tr>
					<td>Total</td>
					<td colspan="4" class="text-center" style="background-color:#384759">
						{% set totalFraisForfaits = 0 %}
						{% for ligneFraisForfait in ligneFraisForfaits %}
							{% set totalFraisForfaits = totalFraisForfaits + (ligneFraisForfait.quantite * fraisForfaits[loop.index0].montant) %}
						{% endfor %}
						{{totalFraisForfaits|format_currency('EUR')}}
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	{% if ficheFrais.idEtat.id != 'CL' %}
		<fieldset disabled="disabled">
		{% endif %}

		{{form_start(formFicheFrais, {'attr': {'class': "row g-3", 'onsubmit': "return confirm('Souhaitez-vous valider les nouvelles quantités de frais forfaitisés ?');"}}
		)}}
		{% for ligneFraisForfait in formFicheFrais.ligneFraisForfaits %}
			<div class="col-md-3">
				<label for="fraisForfait" class="form-label">{{fraisForfaits[loop.index0].libelle}}</label>
				{{form_widget(ligneFraisForfait.quantite, {'attr': {'value': ligneFraisForfaits[loop.index0].quantite }})}}
				{{form_errors(ligneFraisForfait.quantite)}}
			</div>
		{% endfor %}
		<div class="col-12">
			<button class="btn btn-primary">Valider
				<i class="fas fa-check"></i>
			</button>
		</div>
		{{form_end(formFicheFrais)}}

		{% if ficheFrais.idEtat.id != 'CL' %}
		</fieldset>
	{% endif %}
	<br/>

	<h3>Frais hors forfait</h3>
	{% if ligneFraisHorsForfaits == null %}
		<div class="alert alert-primary">
			<h4 class="alert-heading">Aucun frais hors forfait pour ce mois</h4>
		</div>
	{% else %}
		<div class="table-responsive">
			<table class="table table-bordered table-active table-hover table-striped">
				<thead class="thead-dark"></thead>
				<tr class="table-secondary">
					<th class="text-center">Date</th>
					<th>Libelle</th>
					<th>Montant</th>
					<th>Statut</th>
					<th class="text-center">Action</th>
				</tr>
				<tbody>
					{% for ligneFraisHorsForfait in ligneFraisHorsForfaits %}
						<tr>
							<td class="col-md-1 align-middle">{{ligneFraisHorsForfait.date | date('d/m/Y')}}</td>
							<td class="col-md-6 align-middle">
								<b>{{ligneFraisHorsForfait.idStatut.libelle | upper}}
									:
								</b>
								{{ligneFraisHorsForfait.libelle}}</td>
							<td class="col-md-2 align-middle">{{ligneFraisHorsForfait.montant|format_currency('EUR')}}</td>
							<td class="col-md-2 align-middle">{{ligneFraisHorsForfait.idStatut.libelle}}</td>
							<td class="col-md-1" align="center">
								{% if ficheFrais.idEtat.id != 'CL' %}
									<fieldset disabled="disabled">
									{% endif %}

									<form method="post" action="{{ path('modifier_statut_frais_hors_forfait', {'id': ligneFraisHorsForfait.id}) }}" onsubmit="return confirm('Vous allez modifier le statut de ce frais non forfaitisés\nSouhaitez-vous continuer ?');">
										<input type="hidden" name="modifier_statut_frais_hors_forfait_token" value="{{ csrf_token('edit' ~ ligneFraisHorsForfait.id) }}">
										{% if ligneFraisHorsForfait.idStatut.id == 'REF' %}
											<button class="btn btn-success btn-sm" name="nouveau_statut" value="VAL">Valider</button>
										{% elseif ligneFraisHorsForfait.idStatut.id == 'VAL' %}
											<button class="btn btn-danger btn-sm" name="nouveau_statut" value="REF">Refuser</button>
										{% else %}
											<div class="btn-group" role="group">
												<div class="col-md-6 px-1">
													<button class="btn btn-success btn-sm" name="nouveau_statut" value="VAL">Valider</button>
												</div>
												<div class="col-md-6 px-1">
													<button class="btn btn-danger btn-sm" name="nouveau_statut" value="REF">Refuser</button>
												</div>
											</div>
										{% endif %}
									</form>

									{% if ficheFrais.idEtat.id != 'CL' %}
									</fieldset>
								{% endif %}
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	{% endif %}
	<hr/>

	{% if ficheFrais.idEtat.id == 'CL' %}
		<form method="post" action="{{ path('valider_fiche_frais', {'id': ficheFrais.id}) }}" onsubmit="return confirm('Vous allez valider cette fiche de frais.\nSouhaitez-vous continuer ?');">
			<input type="hidden" name="valider_fiche_frais_token" value="{{ csrf_token('validate' ~ ficheFrais.id) }}">
			<button class="btn btn-primary btn">Valider fiche frais</button>
		</form>
		<br/>
	{% endif %}
	{% if ficheFrais.idEtat.id == 'VA' %}
		<form method="post" action="{{ path('rembourser_fiche_frais', {'id': ficheFrais.id}) }}" onsubmit="return confirm('Vous allez indiquer le remboursement de cette fiche de frais.\nSouhaitez-vous continuer ?');">
			<input type="hidden" name="rembourser_fiche_frais_token" value="{{ csrf_token('refund' ~ ficheFrais.id) }}">
			<button class="btn btn-primary btn">Indiquer remboursement</button>
		</form>
		<br/>
	{% endif %}
	{% if ficheFrais.idEtat.id == 'RB' %}
		<div class="alert alert-primary">
			<h4 class="alert-heading">Les frais validés ont été remboursés</h4>
		</div>
	{% endif %}

{% endblock %}
