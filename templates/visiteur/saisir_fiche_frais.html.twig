{% extends 'visiteur/index.html.twig' %}

{% block title %}Saisie fiche frais
{% endblock %}

{% block flashMessages %}
	{% for messages in app.flashes(['ligneFraisForfaitsValidee', 'fraisHorsForfaitAjoute', 'fraisHorsForfaitSupprime']) %}
		{% for message in messages %}
			<div class="alert alert-dismissible alert-success">
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				{{message}}
			</div>
		{% endfor %}
	{% endfor %}
	{% for message in app.flashes('fraisHorsForfaitReporte') %}
			<div class="alert alert-dismissible alert-warning">
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				{{message}} <a href="{{path('consulter_detail_fiche_frais', {'idFicheFrais': ficheFraisFuture.id})}}" class="alert-link">Voir</a>
			</div>
	{% endfor %}	
{% endblock %}

{% block contenuPage %}

	<h1>Saisie de la fiche de frais</h1>
	<hr>
	<h3>Période d'engagement</h3>
	<h4>{{ficheFrais.mois | format_datetime(locale='fr',pattern="MMMM YYYY") | capitalize}}</h4>
	<hr/>

	<h3>Frais au forfait</h3>
	<div class="table-responsive">
		<table class="table table-bordered table-active table-hover table-striped table-responsive">
			<thead class="thead-dark"></thead>
			<tr class="table-secondary">
				<th>Frais forfaitisés</th>
				{% for fraisForfait in fraisForfaits %}
					<th>{{fraisForfait.libelle}}</th>
				{% endfor %}
			</tr>
			<tbody>
				<tr>
					<td>Montant</td>
					{% for fraisForfait in fraisForfaits %}
						<td>{{fraisForfait.montant|format_currency('EUR')}}</td>
					{% endfor %}
				</tr>
				<tr>
					<td>Quantité</td>
					{% for ligneFraisForfait in ligneFraisForfaits %}
						<td>{{ligneFraisForfait.quantite }}</td>
					{% endfor %}
				</tr>
				<tr>
					<td>Total</td>
					{% for ligneFraisForfait in ligneFraisForfaits %}
						<td>{{(ligneFraisForfait.quantite * fraisForfaits[loop.index0].montant)|format_currency('EUR')}}</td>
					{% endfor %}
				</tr>
			</tbody>
		</table>
	</div>

	{{form_start(formFicheFrais, {'attr': {'class': "row g-3", 'onsubmit': "return confirm('Souhaitez-vous valider les nouvelles quantités de frais forfaitisés ?');"}}
	)}}
	{% for ligneFraisForfait in formFicheFrais.lignefraisforfaits %}
		<div class="col-md-3">
			<label for="fraisForfait" class="form-label">{{fraisForfaits[loop.index0].libelle}}</label>
			{{form_widget(ligneFraisForfait.quantite, {'attr': {'value': ligneFraisForfaits[loop.index0].quantite }})}}
			{{form_errors(ligneFraisForfait.quantite)}}
		</div>
	{% endfor %}
	<div class="col-12">
		{{form_widget(formFicheFrais.valider)}}
	</div>
	{{form_end(formFicheFrais)}}
	<br/>

	<h3>Frais hors forfait</h3>
	{% if fraisHorsForfaits == null %}
		<div class="alert alert-info">
			<h4 class="alert-heading">Aucun frais hors forfait pour ce mois</h4>
			<p class="mb-0">Saisissez de nouveaux frais hors forfaits.</p>
		</div>
	{% else %}
		<div class="table-responsive">
			<table class="table table-bordered table-active table-hover table-striped">
				<thead class="thead-dark"></thead>
				<tr class="table-secondary">
					<th class="text-center">Date</th>
					<th>Libelle</th>
					<th>Montant</th>
					<th class="text-center">Action</th>
				</tr>
				<tbody>
					{% for fraisHorsForfait in fraisHorsForfaits %}
						<tr>
							<td class="col-md-1 align-middle">{{fraisHorsForfait.date | date('d/m/Y')}}</td>
							<td class="align-middle">{{fraisHorsForfait.libelle}}</td>
							<td class="col-md-2 align-middle">{{fraisHorsForfait.montant|format_currency('EUR')}}</td>
							<td class="col-md-1">
								<form method="post" action="{{ path('supprimer_fraishorsforfait', {'id': fraisHorsForfait.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette ligne de frais non forfaitisé ?');">
									<input type="hidden" name="supprimer_fraishorsforfait_token" value="{{ csrf_token('delete' ~ fraisHorsForfait.id) }}">
									<button class="btn btn-danger btn-sm">Supprimer</button>
								</form>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	{% endif %}

	{{form_start(formFraisHorsForfait, {'attr': {'class': "row g-3", 'onsubmit': "return confirm('Souhaitez-vous ajouter un nouveau frais non forfaitisé ?');"}})}}
	<div class="col-md-4">
		<label for="fraisHorsForfait" class="form-label">Date</label>
		{{form_widget(formFraisHorsForfait.date)}}
		{{form_errors(formFraisHorsForfait.date)}}
	</div>
	<div class="col-md-4">
		<label for="fraisHorsForfait" class="form-label">Libelle</label>
		{{form_widget(formFraisHorsForfait.libelle)}}
		{{form_errors(formFraisHorsForfait.libelle)}}
	</div>
	<div class="col-md-4">
		<label for="fraisHorsForfait" class="form-label">Montant</label>
		<div class="input-group">
			{{form_widget(formFraisHorsForfait.montant)}}
			<span class="input-group-text bg-primary"> €</span>
			{{form_errors(formFraisHorsForfait.montant)}}
		</div>
	</div>
	<div class="col-12">
		{{form_widget(formFraisHorsForfait.ajouter)}}
	</div>
	{{form_end(formFraisHorsForfait)}}
	<br/>

{% endblock %}
